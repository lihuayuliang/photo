## 本日学习任务：学习数据库对象设计规范和安全操作规范。

### 学习内容：

#### 1.数据类型规范

**1.1常用数据类型**

| **数据类型** | **说明**                                                     |
| ------------ | ------------------------------------------------------------ |
| char         | 定长字符串，最大可存2000字节。如char(10)可以存放10个字节数据，不足10位以空格补齐。 |
| varchar2     | 变长字符串，最大可存储4000字节信息,  可做索引的最大长度749。如varchar2(10)可以存放10个字节数据，不足位自动调整，不用空格补齐。 |
| Number       | 数字类型，如number(12)表示整数，最多存放12位数字；number(12,2)表示浮点数，最多存放12位数字，其中小数点前最多10位数字，小数点后固定为2位。 |
| Date         | 日期/时间数据类型，精确到秒，存储数据格式如DD-MM-YY（HH-MI-SS） |
| Blob         | 二进制数据，最大长度4G                                       |
| clob         | 字符数据，最大长度4G                                         |

**1.2字符型字段**：对于字符型字段，数据类型选择时尽可能的使用**varchar2数据类型**，避免使用**char数据类型**；对于需要存储的字符串长度超过varchar2数据类型规定的**最大长度(4000字节)**的情况，设计时尽量避免使用**blob/clob数据类型**，建议采用定义**多个varchar2类型字段**设计方式或文件存储方式，应用开发在存储字符串时对字段串分割后进行存储，获取字符串时对多个字段存储的字符串查询后进行拼接。

**1.3时间型字段**：时间型字段建议选择date类型，避免使用timestamp类型

**1.4数值型字段**：整数类型字段使用number(p)定义，浮点类型字段使用number(p,s)定义。对于金额类的字段，除特定场景下，系统均使用分为单位，在数据类型选择时优先使用整数类型。

#### 2.表设计规范

**2.1表说明规范**:数据库表设计时应包含详细的中文描述。

表描述说明:

1. 表名称的中文说明，即表的中文名，应保持中文名简洁明了，尽可能引用系统中已有的中文概念；

2. 表功能的中文说明，详细地描述表的具体功能、使用方式、与其它表的关系等；

3. 表的分表方式说明，描述分表的规则；

4. 表的分区方式说明，描述分区方式和分区字段；

5. 表数据的稽核方式说明，如资金类、资源类等关键数据的稽核公式；

6. 表数据的保留期限说明，并说明相应的历史数据清洗规则，数据保留期限可参考下表：

   | **类型**           | **描述**                                           | **保留期限** |
   | ------------------ | -------------------------------------------------- | ------------ |
   | 银行业务记录类     | 银行扣款记录等                                     | 3个月        |
   | 银行托收记录类     | 银行托收记录                                       | 12个月       |
   | 消费积分类         | 用户兑换记录、用户积分清单等                       | 3个月        |
   | 帐务业务记录类     | 帐本收支记录、充值记录、退费记录等                 | 9个月        |
   | 营业业务记录表     | 用户历史记录、营业受理记录、营业统计报表等         | 9个月        |
   | 帐单类             | 用户帐单总表、用户帐单明细表、托收帐单、报损帐单等 | 12个月       |
   | 发票打印记录类     | 发票打印记录表                                     | 6个月        |
   | 批量业务记录类     | 批量业务记录表                                     | 3个月        |
   | 手机月帐单短信发送 | 手机月帐单短信发送表                               | 3个月        |
   | 用户状态变化记录   | 用户状态变化记录表                                 | 12个月       |
   | 电子报表           | 营收缴款报表、渠道报表等                           | 9个月        |
   | 下周期数据         | 下周期数据                                         | 3个月        |
   | 帐本变化通知表     | 帐本变化通知数据                                   | 3个月        |
   | 销户数据           | 销户数据                                           | 3个月        |
   | 开通接口表         | 开通接口数据                                       | 3个月        |
   | 资源类             | 资源类数据                                         | 9个月        |
   | 短信接口           | 短信接口数据                                       | 9个月        |
   | 销账记录类         | 销帐记录                                           | 9个月        |
   | 报损账单类         | 报损账单数据                                       | 12个月       |

​     *2.1.1字段描述说明*

1. 字段名称的中文说明，即字段的中文名，应保持中文名简洁明了，尽可能引用系统中已有字段的中文概念；如果系统中已有对应的字段，应保持设计地一致性。

2. 字段功能的中文说明，详细地描述字段的具体功能、使用方式等，还应包括以下内容：

   (2.1)字段对应枚举值说明，即静态数据来源的说明，如静态数据表中配置的静态数据编号；

   (2.2)对于由指定数据生成规则进行数据生成的公用字段，需要描述字段的生成规则，如三户标识、缴费流水、订单流水等；

​      *2.1.2其他描述说明*

1. 索引对应字段的说明，列出所引用的所有字段；
2. 主键对应字段的说明，列出所引用的所有字段；

**2.2表设计规范**

​      *2.2.1对象大小规范*:单个数据库对象段(Segment，这里主要指表和表分区)的大小原则上不能大于2G，请参照以下规则进行分表/分区设计：

1. 静态数据配置表，不进行分表/分区；
2. 三户资料表、订购信息表等资料类，按地市进行分表；
3. 对有生命周期的数据表设计，包括业务记录表、明细表、日志表，按照表记录中指定时间戳字段进行分表/分区，便于后续的数据备份或迁移，并确保当前表数据保留量；

​      *2.2.2接口表和工单表设计规范*

1. 按照日期进行分区，根据实际查询需要，分区定义在3-5天内；这样可避免频繁增删数据导致表水位过高，以及便于清理维护；

2. 必须使用当前表、历史表(加上帐期)、处理错误表；

   例如：信控工单表设计为：

   当前表 I_EXPORT_ALARM_NNN

   历史表 I_EXPORT_ALARM_NNN_YYYYMM

   处理错误表 I_EXPORT_ALARM_ERR_NNN

3. 必须配置告警信息，以能够对工单积压、异常等情况进行监控；

​     *2.2.3字段设计规范*

1. 将最有可能出现空值的字段放在表结构的最后面，如备注字段；

2. 控制字段定义的长度，不要过度冗余，避免非法或垃圾数据的产生；

   例如：

   1)如果枚举值无需特殊编码，则可将枚举值类型字段长度定义为1或2位；

   2)字符型字段的长度可将250作为临界值；

#### 3.索引设计规范

**3.1索引设计原则**

1. 原则上表索引的个数不能超过5个；
2. 原则上单个字段上的索引不能超过2个；
3. 原则上复合索引引用的字段不能超过3个字段；
4. 原则上分区表的索引类型全部使用LOCAL索引；
5. 配置数据类的表，如数据量比较少，原则上不建索引
6. 接口类和工单类的表，尽可能减少索引数量或者不建索引
7. 索引引用字段的顺序尽可能与使用该索引的查询中ORDER BY字段顺序保持一致

**3.2索引字段选择**

1. 频繁出现在where子句里的字段；
2. 用来和其他表关联的字段；
3. 有较高的选择性和过滤性的字段；
4. 对于**枚举值较少**的字段，建议不要创建B-tree索引，建议建立bitmap索引；
5. 在where子句里作为函数参数的字段，不能创建索引，不建议建立函数索引;
6. 建立索引的时候，建议考虑到select和insert,update,delete的平衡；
7. 一般建议在查询数据量**10%**以下使用索引

**3.3复合索引字段选择**

1. where子句的查询条件构成索引字段前沿列，频繁查询的字段放在前面；
2. 如果所有字段查询频率相同，则把选择性好的字段放在前面；
3. 如果所有字段查询频率相同，则把排列顺序的字段放在前面；
4. 复合索引使用规律:索引index(a,b,c) ，在where 条件里，(a)、(a,b)、（a,b,c）、（a,c）组合可用到索引;(b)、（b,c）、（c）组合用不到索引。

#### 4.主键设计规范

1. 主键字段应独立于业务规则，比如业务规则不能从主键值中解析某几位来获取信息；
2. 主键字段值由数据库序列生成，如无特殊需要，应避免通过程序编码方式生成唯一值；
3. 原则上表必须设计主键，尤其是资料类、业务记录类表；

#### 5.外键设计规范

​        原则上不允许使用外键，在应用层面保证数据的一致性；只允许在数据模型设计时在表中增加外键，以标识出各表之间的关联关系。

#### 6.序列设计规范

1. 原则上禁止使用序列的循环功能(cycle)；
2. 原则上单节点数据库，序列的Cache值不低于100；RAC数据库，序列的Cache值不低于400；
3. 同一个基表衍生出的所有分表共用一个序列，基表间不能共用序列；
4. 对于多中心规划的数据库，本中心库分表共用一个序列，每个中心库序列命名相同； 
5. 对于多中心规划的数据库，应用程序设计序列时必须确保多中心同一类数据汇总后不会发生主键冲突；



---------------------------------------



#### 1.安全访问规范

**1.1生产用户使用规范**

1. 生产库用户密码由数据库组统一管理，禁止用户明文密码外泄；
2. 除应用程序外，禁止使用数据库生产用户直接登录；维护类工作通过维护类帐号进行操作。

**1.2非生产用户使用规范**

1. 生产数据库的非生产用户创建的对象存储容量不能超过100G；
2. 生产数据库的非生产用户生成的临时对象必须放在该用户下；
3. 原则上非DBA使用的非生产用户不应授予ANY类的DDL权限，非维护用户不应授予ANY类的DML权限；

**1.3用户安全访问规范**

1. 原则上开发人员不能直接连接生产数据库进行相关操作；
2. 在紧急情况需要开发人员配合解决问题的情况下，可以通过维护人员配合提供个人用户或由数据库管理员临时分配具有相当权限的用户；

#### 2.配置上线规范

**2.1命名规范**：编号#生产数据库名#生产用户名#姓名#手机号#操作类型#需求单号#需求名称.sql

**2.2内容规范**:

1. 添加数据库地址及用户名的注释；

2. 脚本语句前需要先关闭替代变量功能及设置当前数据库用户

3. 每条脚本需添加注释，说明脚本运行的目的

4. 脚本末尾添加commit


![image-20220815141948906](https://cdn.jsdelivr.net/gh/lihuayuliang/photo/image-20220815141948906.png)

#### 3.开发安全规范

1. 严禁使用“for update”(排他锁)

      例如：SELECT * FROM INS_USER_571 WHERE USER_NAME = ‘张三’ FOR UPDATE;

2. 严禁使用存储过程（简单理解存储过程，事先创建了一个函数，当需要使用的时候，可以直接调用，无需再重复写sql语句了。）

